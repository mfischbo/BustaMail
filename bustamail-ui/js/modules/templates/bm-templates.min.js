BMApp.Templates=angular.module("TemplatesModule",["SecurityModule","TemplateServiceModule","ui.codemirror","angularFileUpload"]),BMApp.Templates.config(["$routeProvider",function(e){e.when("/templates/packs",{templateUrl:"./js/modules/templates/tmpl/packs/index.html",controller:"TemplatePacksIndexController"}).when("/templates/packs/create",{templateUrl:"./js/modules/templates/tmpl/packs/create.html",controller:"TemplatePacksCreateController"}).when("/templates/packs/:id/edit",{templateUrl:"./js/modules/templates/tmpl/packs/edit.html",controller:"TemplatePacksEditController"})}]),BMApp.Templates.controller("TemplatePacksIndexController",["TemplateService","$http","$scope","$upload",function(e,t,p,i){p.owner=void 0,p.packs={},p.$watch("owner",function(t){t&&e.getTemplatePacksByOwner(t).success(function(e){p.packs=e})}),p.copyPack=function(e){BMApp.showSpinner(),t.put("/api/templates/packs/"+e+"/clone").success(function(e){p.packs.content.push(e),BMApp.hideSpinner()}).error(function(){BMApp.hideSpinner()})},p.deletePack=function(t){BMApp.confirm("Soll der Template Pack und alle seine Inhalte wirklich entfernt werden?",function(){e.deleteTemplatePack(t).success(function(){KT.remove("id",t,p.packs)})})},p.onZipFileSelect=function(e){BMApp.showSpinner(),p.upload=i.upload({url:"/api/templates/"+p.owner+"/packs/upload",method:"POST",file:e[0]}).success(function(e){BMApp.hideSpinner(),p.packs.content.push(e),BMApp.alert("Das Template Pack wurde erfolgreich hochgeladen")}).error(function(){BMApp.hideSpinner()})}}]),BMApp.Templates.controller("TemplatePacksCreateController",["TemplateService","$scope","$location",function(e,t,p){t.pack={},t.dismissForm=function(){p.path("/templates/packs")},t.savePack=function(){e.createTemplatePack(t.pack).success(function(e){p.path("/templates/packs/"+e.id+"/edit")})}}]),BMApp.Templates.controller("TemplatePacksEditController",["TemplateService","$http","$scope","$routeParams","$location","$upload",function(e,t,p,i,n,s){p.pack={},p.tab="PACK",p.template=void 0,p.resource=void 0,p.widgets=void 0,p.templateFiles=[],p.templateResources=[];var a,o,l,c;e.getTemplatePackById(i.id).success(function(e){p.pack=e}),p.setupCodeMirror=function(e){e.setOption("lineNumbers",!0),e.setOption("mode","htmlmixed"),p.template&&p.template.source&&e.setOption("value",p.template.source),a=e},p.setupHTMLHeadCodeMirror=function(e){e.setOption("lineNumbers",!0),e.setOption("mode","htmlmixed"),p.template&&p.template.htmlHead?e.setOption("value",p.template.htmlHead):e.setOption("value",""),o=e},p.setupCodeMirrorWidget=function(e){e.setOption("lineNumbers",!0),e.setOption("mode","htmlmixed"),p.widget&&p.widget.source&&e.setOption("value",p.widget.source),l=e},p.setupResourceCodeMirror=function(e){e.setOption("lineNumbers",!0),e.setOption("mode","htmlmixed"),c=e},p.switchTab=function(e){"SOURCE"==e&&window.setTimeout(function(){a.refresh()},200),"HEAD"==e&&window.setTimeout(function(){o.refresh()},200)},p.dismissForm=function(){"TEMPLATES"==p.tab&&(p.template=void 0),"PACK"==p.tab&&n.path("/templates/packs"),"WIDGETS"==p.tab&&(p.widget=void 0)},p.saveAction=function(){p.widget.source=l.getValue(),p.template.source=a.getValue(),e.updateTemplatePack(p.pack).success(function(e){p.pack=e})},p.onThemeFileSelect=function(e){BMApp.showSpinner(),p.upload=s.upload({url:"/api/templates/packs/"+i.id+"/themeImage",method:"POST",file:e[0]}).success(function(e){p.pack.themeImage=e,BMApp.hideSpinner(),BMApp.alert("Das Bild wurde erfolgreich gespeichert")})},p.onFileSelect=function(e){for(var t in e)p.templateFiles.push(e[t])},p.onFileSelectResource=function(e){for(var t in e)p.templateResources.push(e[t])},p.uploadTemplateImages=function(){for(var e in p.templateFiles)BMApp.showSpinner(),p.upload=s.upload({url:"/api/templates/templates/"+p.template.id+"/images",method:"POST",file:p.templateFiles[e]}).success(function(e){p.template.images.push(e),BMApp.utils.remove("name",e.name,p.templateFiles),0==p.templateFiles.length&&BMApp.hideSpinner()})},p.uploadTemplateResources=function(){for(var e in p.templateResources)BMApp.showSpinner(),p.upload=s.upload({url:"/api/templates/templates/"+p.template.id+"/resources",method:"POST",file:p.templateResources[e]}).success(function(e){p.template.resources.push(e),BMApp.utils.remove("name",e.name,p.templateResources),0==p.templateResources.length&&BMApp.hideSpinner()})},p.deleteTemplateImage=function(e){BMApp.confirm("Soll das Bild wirklich aus dem Template entfernt werden?",function(){t({method:"DELETE",url:"/api/templates/templates/"+p.template.id+"/images/"+e}).success(function(){BMApp.utils.remove("id",e,p.template.images)})})},p.deleteTemplateResource=function(e){BMApp.confirm("Soll die Datei wirklich aus dem Template entfernt werden?",function(){t({method:"DELETE",url:"/api/templates/templates/"+p.template.id+"/resources/"+e}).success(function(){BMApp.utils.remove("id",e,p.template.resources)})})},p.focusResource=function(e){t.get("/api/media/"+e+"/content").success(function(t){p.resource=BMApp.utils.find("id",e,p.template.resources),(p.resource.mimetype="text/css")&&c.setOption("mode","css"),(p.resource.mimetype="text/javascript")&&c.setOption("mode","javascript"),c.setValue(t),window.setTimeout(function(){c.refresh()},200)})},p.unfocusResource=function(){p.resource=void 0},p.saveResource=function(){t({url:"/api/media/"+p.resource.id+"/content",method:"PATCH",data:c.getValue(),headers:{"Content-Type":"text/plain"}}).success(function(){BMApp.alert("Erfolgreich gespeichert")})},p.addTemplate=function(){p.template={},p.pack.templates.push(p.template)},p.copyTemplate=function(e){t.put("/api/templates/packs/"+i.id+"/templates/"+e+"/clone").success(function(e){p.pack.templates.push(e),BMApp.hideSpinner()}).error(function(){BMApp.hideSpinner()})},p.focusTemplate=function(e){p.template=e,a&&a.setValue(p.template.source),o&&o.setValue(p.template.htmlHead||""),p.widgets=void 0},p.addWidget=function(){p.widget={},p.template.widgets.push(p.widget)},p.showWidgets=function(e){p.template=e,p.widgets=e.widgets},p.focusWidget=function(e){p.widget=e,l&&l.setValue(p.widget.source)}}]);